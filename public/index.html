<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>WA Pairing - Multi</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;max-width:900px}
    input,button{padding:8px;margin:6px 0}
    pre{background:#f6f6f6;border:1px solid #ddd;padding:12px}
  </style>
</head>
<body>
  <h1>WhatsApp Pairing (pairing-code method)</h1>
  <p>Enter phone number in international format (no +). Example: 254712345678</p>

  <input id="phone" placeholder="2547..." style="width:300px" />
  <button id="gen">Generate pairing code</button>

  <div id="box" style="margin-top:18px"></div>

  <script>
    async function poll(phone){
      const out = document.getElementById('box');
      out.innerHTML = 'Polling status...';
      const url = '/status/' + phone;
      const iv = setInterval(async ()=>{
        const r = await fetch(url);
        if(r.status !== 200){ out.innerHTML = 'Session not found'; clearInterval(iv); return; }
        const s = await r.json();
        out.innerHTML = '<pre>' + JSON.stringify(s,null,2) + '</pre>';
        if(s.code) {
          out.innerHTML += '<p><strong>Pairing code:</strong> ' + s.code + '</p>';
          out.innerHTML += '<p>Use WhatsApp → Linked devices → Link with phone number, enter code above.</p>';
        }
        if(s.status === 'paired') {
          clearInterval(iv);
          out.innerHTML += `<p style="color:green">Paired! You can <a href="/download/${phone}">download creds.json</a></p>`;
        }
        if(['timeout','error','closed'].includes(s.status)) {
          clearInterval(iv);
          out.innerHTML += `<p style="color:red">Pairing failed: ${s.error || s.status}</p>`;
        }
      }, 2000);
    }

    document.getElementById('gen').addEventListener('click', async ()=>{
      const phone = document.getElementById('phone').value.trim();
      if(!phone){ alert('Enter phone'); return; }
      const r = await fetch('/generate', { method:'POST', headers: {'content-type':'application/json'}, body: JSON.stringify({ phone })});
      const j = await r.json();
      if(j.ok){
        poll(phone);
      } else {
        alert(JSON.stringify(j));
      }
    });
  </script>
</body>
</html>
